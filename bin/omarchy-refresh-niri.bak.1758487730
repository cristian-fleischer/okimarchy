#!/bin/bash
set -euo pipefail

# Compose ~/.config/niri/config.kdl from defaults + user overrides
confdir="$HOME/.config/niri"
defdir="$HOME/.local/share/omarchy/default/niri"
mkdir -p "$confdir"

outfile="$confdir/config.kdl"

{
  echo ";; Generated by omarchy-refresh-niri â€” edit ~/.config/niri/*.kdl to override"
  echo
  # Input
  if [[ -f "$defdir/input.kdl" ]]; then cat "$defdir/input.kdl"; echo; fi
  if [[ -f "$confdir/input.kdl" ]]; then cat "$confdir/input.kdl"; echo; fi

  # Layout
  if [[ -f "$defdir/layout.kdl" ]]; then cat "$defdir/layout.kdl"; echo; fi
  if [[ -f "$confdir/layout.kdl" ]]; then cat "$confdir/layout.kdl"; echo; fi

  # Bindings
  if [[ -f "$defdir/bindings.kdl" ]]; then cat "$defdir/bindings.kdl"; echo; fi
  if [[ -f "$confdir/bindings.kdl" ]]; then cat "$confdir/bindings.kdl"; echo; fi

  # Monitors (outputs)
  if [[ -f "$defdir/monitors.kdl" ]]; then cat "$defdir/monitors.kdl"; echo; fi
  if [[ -f "$confdir/monitors.kdl" ]]; then cat "$confdir/monitors.kdl"; echo; fi

  # Window rules
  if [[ -f "$defdir/rules.kdl" ]]; then cat "$defdir/rules.kdl"; echo; fi
  if [[ -f "$confdir/rules.kdl" ]]; then cat "$confdir/rules.kdl"; echo; fi

  # Startup
  if [[ -f "$defdir/startup.kdl" ]]; then cat "$defdir/startup.kdl"; echo; fi
  if [[ -f "$confdir/startup.kdl" ]]; then cat "$confdir/startup.kdl"; echo; fi
} > "$outfile"

# If niri-companion is installed, allow it to regenerate (optional)
if command -v niri-genconfig &>/dev/null; then
  # Let companion manage if present; ignore errors
  niri-genconfig || true
fi

echo "Wrote $outfile"
